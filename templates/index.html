<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ground Station - Real-Time Drone Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <!-- Socket.IO Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f0f2f5;
        }
        #header {
            background-color: #ffffff;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1001;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        #header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
        }
        #telemetry {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .telemetry-item {
            font-size: 0.9rem;
            color: #555;
        }
        .telemetry-item strong {
            color: #000;
        }
        #status {
            font-weight: bold;
            padding: 0.4rem 0.8rem;
            border-radius: 1rem;
            color: #fff;
            transition: background-color 0.3s;
        }
        .status-connecting { background-color: #ffc107; color: #333;}
        .status-connected { background-color: #28a745;}
        .status-disconnected { background-color: #dc3545;}
        #map {
            flex-grow: 1;
            width: 100%;
            height: 100%; /* Fallback for browsers not supporting flex-grow */
        }
    </style>
</head>
<body>

    <div id="header">
        <h1>Drone Ground Station</h1>
        <div id="telemetry">
            <div class="telemetry-item"><strong>Lat:</strong> <span id="lat">--.--</span></div>
            <div class="telemetry-item"><strong>Lon:</strong> <span id="lon">--.--</span></div>
            <div class="telemetry-item"><strong>Alt (m):</strong> <span id="alt">--.--</span></div>
        </div>
        <div id="status" class="status-connecting">Connecting...</div>
    </div>

    <div id="map"></div>

    <script>
        // --- Map Initialization ---
        // Initialize the map, centered on a default location. It will be re-centered on first GPS fix.
        const map = L.map('map').setView([51.505, -0.09], 13);

        // Add a tile layer to the map (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- Drone Icon and Path ---
        let droneMarker = null;
        // SVG for a more appealing drone icon
        const droneIconSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="36" height="36" fill="#3498db">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5-10-5-10 5z"/>
            </svg>`;
        const droneIcon = L.divIcon({
            html: droneIconSVG,
            className: 'drone-icon', // an empty class name, so we can style it if needed
            iconSize: [36, 36],
            iconAnchor: [18, 18],
        });

        // Polyline to trace the drone's path
        const flightPath = L.polyline([], { color: 'red', weight: 3 }).addTo(map);
        
        let firstGpsUpdate = true;

        // --- Socket.IO Connection ---
        const socket = io();

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            updateStatus('Disconnected', 'disconnected');
        });

        // --- Event Listeners ---
        socket.on('status_update', (data) => {
            console.log('Status Update:', data.message);
            if (data.message.includes('Connected')) {
                updateStatus(data.message, 'connected');
            } else if (data.message.includes('Disconnected')) {
                updateStatus(data.message, 'disconnected');
            } else {
                updateStatus(data.message, 'connecting');
            }
        });
        
        socket.on('gps_update', (data) => {
            const { lat, lon, alt } = data;
            // console.log('Received GPS update:', data); // Uncomment for debugging

            // Update telemetry display
            document.getElementById('lat').textContent = lat.toFixed(6);
            document.getElementById('lon').textContent = lon.toFixed(6);
            document.getElementById('alt').textContent = alt.toFixed(2);

            const newPosition = [lat, lon];

            if (firstGpsUpdate) {
                // Center map on first received coordinate
                map.setView(newPosition, 17);
                // Create and add the marker to the map
                droneMarker = L.marker(newPosition, { icon: droneIcon }).addTo(map)
                    .bindPopup("Drone Position")
                    .openPopup();
                firstGpsUpdate = false;
                updateStatus('GPS Lock Acquired', 'connected');
            } else {
                // Update marker position
                if (droneMarker) {
                    droneMarker.setLatLng(newPosition);
                }
            }

            // Add new point to the flight path
            flightPath.addLatLng(newPosition);
            
            // Optionally, keep the drone centered on the map
            // map.panTo(newPosition);
        });

        // --- Helper Functions ---
        function updateStatus(message, statusClass) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = ''; // clear existing classes
            statusEl.classList.add(`status-${statusClass}`);
        }
    </script>

</body>
</html>
